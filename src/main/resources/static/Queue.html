<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Management</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .queue-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 300px;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        #queuePosition {
            font-size: 18px;
            margin: 20px 0;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="queue-container">
        <h1>대기열</h1>
        <div id="queuePosition">대기 순번: --</div>
    </div>

    <script>
        let isEnterCalled = false; // 중복 호출 방지 플래그
        let socketInitialized = false; // WebSocket 초기화 방지 플래그

        document.addEventListener("DOMContentLoaded", function () {

            // 대기열 상태 브로드캐스트 호출
            setTimeout(() => {
                fetch("/getBroadcastQueueStatus")
                    .then(() => console.log("대기열 상태 브로드캐스트 호출"))
                    .catch((error) => console.error("대기열 상태 브로드캐스트 호출 에러 :", error));
            }, 500);
            
            const userId = sessionStorage.getItem("userId");
            if (userId) {
                const isInitialRedirect = sessionStorage.getItem("isInitialRedirect") === "true";
                if (isInitialRedirect) {
                    console.log("리다이렉션 완료 상태 감지. 최초 접속 상태 초기화.");
                    console.log("User Id : " + userId);
                    sessionStorage.setItem("isInitialRedirect", "false");
                    sessionStorage.setItem("isInitialLoad", "false"); // 최초 접속 아님
                } else {
                    console.log("기존 userId 감지:", userId);
                    sessionStorage.setItem("isInitialLoad", "false"); // 최초 접속 아님
                }
                initializeWebSocket(); // 기존 ID로 WebSocket 초기화
            } else {
                console.log("최초 접속 User ID");
                sessionStorage.setItem("isInitialLoad", "true"); // 최초 접속 플래그 설정
                enterSite(); // 새로운 userId 생성
            }
        });

        function enterSite() {
            if (isEnterCalled) {
                console.log("isEnterCalled = true");
                return;
            }

            isEnterCalled = true; // 요청 상태 설정

            setTimeout(() => {
                fetch("/enter")
                    .then((response) => response.json())
                    .then((data) => {
                        console.log("User ID:", data.userId);
                        console.log("Redirect URL:", data.redirectUrl);

                        // sessionStorage에 사용자 ID 저장
                        sessionStorage.setItem("userId", data.userId);

                        // 리다이렉션 수행
                        if (!window.location.pathname.includes(data.redirectUrl)) {
                            console.log("리다이렉션 :", data.redirectUrl);
                            sessionStorage.setItem("isInitialRedirect", "true");
                            window.location.replace(data.redirectUrl);
                        } else {
                            sessionStorage.setItem("isInitialRedirect", "false");
                            console.log("현재 페이지 유지. WebSocket 초기화.");
                            initializeWebSocket(); // WebSocket 초기화
                        }
                    })
                    .catch((error) => console.error("/enter 패치 에러:", error))
                    .finally(() => {
                        isEnterCalled = false; // 요청 상태 플래그 해제
                    });
            }, 1000); // 딜레이 적용 (1000ms)
        }

        function initializeWebSocket() {
            if (socketInitialized) {
                console.log("socketInitialized = true");
                return;
            }

            socketInitialized = true;

            let socket = new WebSocket("ws://localhost:8080/queue");

            socket.onmessage = function (event) {
                let message = JSON.parse(event.data);
                console.log("메세지:", message);

                if (message.action === "position" && message.userId === getCurrentUserId()) {
                    let queuePosition = document.getElementById("queuePosition");
                    queuePosition.textContent = `대기 순번: ${message.position}`;
                } else if (message.action === "redirect" && message.userId === getCurrentUserId()) {
                    window.location.href = message.url;
                }
            };

            socket.onopen = function () {
                console.log("WebSocket 연결");
            };

            socket.onclose = function () {
                console.log("WebSocket 연결 종료");
                delete window.socket;
            };

            socket.onerror = function (error) {
                console.error("WebSocket 에러:", error);
            };
        }

        function getCurrentUserId() {
            return sessionStorage.getItem("userId") || "unknown";
        }

    let isExitCalled = false;

    window.onbeforeunload = function () {
            if (isExitCalled) {
                console.log("Exit 중복 실행 방지.");
                return;
            }

            const userId = sessionStorage.getItem("userId");
            const isInitialLoad = sessionStorage.getItem("isInitialLoad") === "true";
            const isInitialRedirect = sessionStorage.getItem("isInitialRedirect") === "true";

            if (!userId || isInitialLoad || isInitialRedirect) {
                console.log("최초 접속 또는 리다이렉션 상태로 Exit 요청 생략.");
                sessionStorage.setItem("isInitialLoad", "false");
                sessionStorage.setItem("isInitialRedirect", "false");
                return;
            }

            const isRefresh = performance.navigation.type === performance.navigation.TYPE_RELOAD;
            const url = "/exit";
            const data = new URLSearchParams({ userId: userId, refresh: isRefresh });

            // `sendBeacon` 우선 실행
            const success = navigator.sendBeacon(url, data);
            console.log("SendBeacon으로 Exit 요청 성공");
            isExitCalled = true; // 플래그 설정
        };
    </script>
</body>
</html>
